<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
        <title>Minecraft Cape Creator</title>
    </head>
    <body data-bs-theme="dark">
        <div class="container-fluid">
            <div class="row justify-content-center">
                <div class="col-xl-6 col-md-8 col-12">
                    <div id="app" class="p-5">
                        <h1>Minecraft Cape Creator</h1>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-1">
                                <div>
                                    <h4>Select Image</h4>
                                    <input type="file" class="form-control" @change="uploadImage" accept="image/*">
                                </div>
                                <br>
                                <div>
                                    <h4>Set Color</h4>
                                    <input type="color" class="form-control" v-model="color" @change="changeColour">
                                </div>
                                <br>
                                <div>
                                    <h4>Set Scale ({{visualiseScale()}})</h4>
                                    <input type="range" class="form-range" min="1" max="6" step="1" v-model="scale" @change="changeScale">
                                </div>
                                <hr>
                                <div>
                                    <img id="cropper-image" :src="templateImageSrc" class="mw-100"/>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <canvas id="minecraft-skin-viewer" class="border rounded shadow-lg"></canvas>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-md-6 mb-1">
                                <h3 class="text-center">Your Cape</h3>
                                <p>This is your final cape design. You can download your cape by using the button below.</p>
                                <p>This project aims to help users move images onto capes with minimual effort.</p>
                                <button @click="downloadCape" class="btn btn-primary">Download Cape</button>
                            </div>
                            <div class="col-md-6">
                                <img :src="capePreviewSrc" class="texture-preview w-100 border mb-1"/>
                            </div>
                            <hr class="my-2">
                        </div>
                        <hr>
                        <div class="text-center">
                            Created by <a target="_blank" href="https://github.com/james090500">James Harrison</a> for <a target="_blank" href="https://minecraftcapes.net">MinecraftCapes</a>
                            <br>
                            <a target="_blank" href="https://github.com/minecraftcapes/minecraft-cape-creator">View us on GitHub</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <link rel="stylesheet" href="https://unpkg.com/cropperjs@1.6.2/dist/cropper.min.css"/>
        <style>
            #minecraft-skin-viewer {
                width: 100%;
                height: 100%;
                display: block;
                background: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgAQMAAABJtOi3AAAABlBMVEUgIDAcHCq70aXDAAAAE0lEQVQI12P4/5+BgZoEA3VNBADtvT/BrQ+bEwAAAABJRU5ErkJggg==');
                background-repeat: repeat;
            }

            @media (max-width: 576px) {
                #minecraft-skin-viewer {
                    height: 50vh;
                }
            }

            .texture-preview {
                image-rendering: optimizeSpeed;             /* Legal fallback                 */
                image-rendering: -moz-crisp-edges;          /* Firefox                        */
                image-rendering: -o-crisp-edges;            /* Opera                          */
                image-rendering: -webkit-optimize-contrast; /* Chrome (and eventually Safari) */
                image-rendering: optimize-contrast;         /* CSS3 Proposed                  */
                -ms-interpolation-mode: nearest-neighbor;   /* IE8+                           */
                image-rendering: pixelated;                 /* Chrome 41+, Firefox            */
            }
        </style>
        <script type="module">
            import { createApp } from 'https://unpkg.com/vue@3/dist/vue.esm-browser.js'
            import CropperJS from 'https://unpkg.com/cropperjs@1.6.2/dist/cropper.esm.js'
            import MinecraftSkinViewer from 'minecraft-skin-viewer'
            import MinecraftCapeCreator from './src/main.js'

            createApp({
                data() {
                    return {
                        minecraftSkinViewer: null,
                        minecraftCapeCreator: new MinecraftCapeCreator(),
                        cropper: null,
                        file: "",
                        color: "#FF0000",
                        scale: 1,
                        templateImageSrc: "https://upload.wikimedia.org/wikipedia/commons/a/a5/Red_Kitten_01.jpg",
                        capePreviewSrc: null,
                    }
                },
                mounted() {
                    let image = document.getElementById('cropper-image')
                    this.cropper = new CropperJS(image, {
                        aspectRatio: 10 / 16,
                        guides: false,
                        ready: this.changeImage,
                        cropend: this.changeImage,
                        zoomable: false
                    })

                    this.minecraftSkinViewer = new MinecraftSkinViewer({
                        canvas: document.getElementById('minecraft-skin-viewer')
                    })
                    this.minecraftSkinViewer.playerObject.group.rotation.y = Math.PI

                    this.buildCape()
                },
                methods: {
                    visualiseScale() {
                        let realScale = Math.pow(2, this.scale - 1)
                        return `${64 * realScale} / ${32 * realScale}`
                    },
                    uploadImage(event) {
                        var reader = new FileReader()
                        reader.readAsDataURL(event.target.files[0])
                        reader.onload = () => {
                            this.cropper.replace(reader.result)
                        };
                    },
                    changeImage() {
                        this.minecraftCapeCreator.setImage(this.cropper.getCroppedCanvas().toDataURL())
                        this.buildCape();
                    },
                    changeColour() {
                        this.minecraftCapeCreator.setColor(this.color)
                        this.buildCape()
                    },
                    changeScale() {
                        this.minecraftCapeCreator.setScale(this.scale)
                        this.buildCape()
                    },
                    buildCape() {
                        this.minecraftCapeCreator.buildCape().then(value => {
                            this.capePreviewSrc = value;
                            this.minecraftSkinViewer.loadCape(this.capePreviewSrc)
                        })
                    },
                    downloadCape() {
                        this.minecraftCapeCreator.downloadCape();
                    }
                }
            }).mount('#app')
          </script>
    </body>
</html>